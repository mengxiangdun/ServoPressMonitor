<!DOCTYPE html>
<html>
<head>
    <title>Kaanh Intelligence</title>
    <link rel='stylesheet' href='./style.css' />
    <script src="external/jquery/jquery.js"></script>
    <script src="jquery-ui.js"></script>
    <script src="echarts.js"></script>
    <title>Servo Press Monitor</title>
    <link href="jquery-ui.css" rel="stylesheet">
    <link href="/jquery-ui.css" rel="stylesheet">
</head>
<body>
<p>Welcome to Kaanh Intelligence</p>
<input id="serverIP" placeholder="Enter server ip"/>
<button id="getXml" >Get Configuration</button>
<button id="saveXml">Save & Run</button>

<table id="InputTable_Temp" border="1" style="width: 600px">
    <tr bgcolor="#ffe4c4">
        <td style="width: 40%">CH</td>
        <td style="width: 20%">1</td>
        <td style="width: 20%">2</td>
        <td style="width: 20%">4</td>
    </tr>
</table>
<table id="InputTable" border="1" style="width:600px">
    <tr>
        <td style="width: 40%">CH</td>
        <td style="width: 20%">1</td>
        <td style="width: 20%">2</td>
        <td style="width: 20%">4</td>
    </tr>
    <tr bgcolor="#ffe4c4">
        <td style="width: 40%">Header</td>
        <td style="width: 20%"></td>
        <td style="width: 20%"></td>
        <td style="width: 20%"></td>
    </tr>
    <tr>
        <td>SP000 PRESS SCALE</td>
        <td><input id="ch1_s" style="width: auto"/></td>
        <td><input id="ch2_s"/></td>
        <td><input id="ch3_s"/></td>
    </tr>
    <tr>
        <td>SP000 PRESS TIME</td>
        <td><input id="ch1_time"/></td>
        <td><input id="ch2_time"/></td>
        <td><input id="ch3_time"/></td>
    </tr>
    <tr>
        <td>SP000 PRESS BEGIN POS</td>
        <td><input id="ch1_begin_pos"/></td>
        <td><input id="ch2_begin_pos"/></td>
        <td><input id="ch3_begin_pos"/></td>
    </tr>
    <tr>
        <td>SP000 PRESS POS</td>
        <td><input id="ch1_pos"/></td>
        <td><input id="ch2_pos"/></td>
        <td><input id="ch3_pos"/></td>
    </tr>
    <tr>
        <td>SP000 PRESS VEL</td>
        <td><input id="ch1_vel"/></td>
        <td><input id="ch2_vel"/></td>
        <td><input id="ch3_vel"/></td>
    </tr>
    <tr>
        <td>SP000 PRESS ACC</td>
        <td><input id="ch1_acc"/></td>
        <td><input id="ch2_acc"/></td>
        <td><input id="ch3_acc"/></td>
    </tr>
    <tr>
        <td>SP000 PRESS DEC</td>
        <td><input id="ch1_dec"/></td>
        <td><input id="ch2_dec"/></td>
        <td><input id="ch3_dec"/></td>
    </tr>
    <tr>
        <td>SP000 PRESS AB</td>
        <td><input id="ch1_ab"/></td>
        <td><input id="ch2_ab"/></td>
        <td><input id="ch3_ab"/></td>
    </tr>
    <tr>
        <td>SP001 CHANNEL SPAN SELECT</td>
        <td><select id="ch1_channel_span_select"><option>OFF</option><option>ON</option></select></td>
        <td><select id="ch2_channel_span_select"><option>OFF</option><option>ON</option></select></td>
        <td><select id="ch3_channel_span_select"><option>OFF</option><option>ON</option></select></td>
    </tr>
    <tr>
        <td>SP002 CHANNEL SPAN</td>
        <td><input id="ch1_channel_span"/></td>
        <td><input id="ch2_channel_span"/></td>
        <td><input id="ch3_channel_span"/></td>
    </tr>
    <tr>
        <td>SP003 SCALE ADJUST</td>
        <td><input id="ch1_scale_adjust"/></td>
        <td><input id="ch2_scale_adjust"/></td>
        <td><input id="ch3_scale_adjust"/></td>
    </tr>
    <tr>
        <td>SP101 OFFSET LOAD</td>
        <td><input id="ch1_offset_load"/></td>
        <td><input id="ch2_offset_load"/></td>
        <td><input id="ch3_offset_load"/></td>
    </tr>
    <tr>
        <td>SP201 PRESS CURVE</td>
        <td><select><option>ON</option><option>OFF</option></select></td>
        <td><select><option>ON</option><option>OFF</option></select></td>
        <td><select><option>ON</option><option>OFF</option></select></td>
    </tr>
    <tr>
        <td>SP301 STAGE SELECT</td>
        <td><select><option>ON</option><option>OFF</option></select></td>
        <td><select><option>ON</option><option>OFF</option></select></td>
        <td><select><option>ON</option><option>OFF</option></select></td>
    </tr>
    <tr>
        <td>SP302 STAGE PAUSE</td>
        <td><select><option>ON</option><option>OFF</option></select></td>
        <td><select><option>ON</option><option>OFF</option></select></td>
        <td><select><option>ON</option><option>OFF</option></select></td>
    </tr>
    <tr>
        <td>SP303 OK FINISH FEED BACK</td>
        <td><select><option>ON</option><option>OFF</option></select></td>
        <td><select><option>ON</option><option>OFF</option></select></td>
        <td><select><option>ON</option><option>OFF</option></select></td>
    </tr>
    <tr>
        <td>SP304 NG FINISH FEED BACK</td>
        <td><select><option>ON</option><option>OFF</option></select></td>
        <td><select><option>ON</option><option>OFF</option></select></td>
        <td><select><option>ON</option><option>OFF</option></select></td>
    </tr>
    <tr bgcolor="#ffe4c4">
        <td>FEED STAGE</td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>SP501 THRESHOLD LOAD</td>
        <td><input id="ch1_threshold_load"/></td>
        <td><input id="ch2_threshold_load"/></td>
        <td><input id="ch3_threshold_load"/></td>
    </tr>
    <tr>
        <td>SP502 FEED STAGE LOAD</td>
        <td><input/></td>
        <td><input/></td>
        <td><input/></td>
    </tr>
    <tr>
        <td>SP503 FEED STAGE UPPER LOAD</td>
        <td><input/></td>
        <td><input/></td>
        <td><input/></td>
    </tr>
    <tr>
        <td>SP504 FEED STAGE LOW LOAD</td>
        <td><input/></td>
        <td><input/></td>
        <td><input/></td>
    </tr>
    <tr>
        <td>SP505 FEED STAGE HIGH SPEED POSITION</td>
        <td><input/></td>
        <td><input/></td>
        <td><input/></td>
    </tr>
    <tr>
        <td>SP506 FEED STAGE HIGH SPEED</td>
        <td><input/></td>
        <td><input/></td>
        <td><input/></td>
    </tr>
    <tr>
        <td>SP507 FEED STAGE MID SPEED</td>
        <td><input/></td>
        <td><input/></td>
        <td><input/></td>
    </tr>
    <tr>
        <td>SP508 FEED STAGE UP SLOPE</td>
        <td><input/></td>
        <td><input/></td>
        <td><input/></td>
    </tr>
    <tr>
        <td>SP509 FEED STAGE DOWN SLOPE</td>
        <td><input/></td>
        <td><input/></td>
        <td><input/></td>
    </tr>
    <tr>
        <td>SP510 FEED STAGE MIN TIME</td>
        <td><input/></td>
        <td><input/></td>
        <td><input/></td>
    </tr>
    <tr>
        <td>SP511 FEED STAGE MAX TIME</td>
        <td><input/></td>
        <td><input/></td>
        <td><input/></td>
    </tr>
    <tr>
        <td>SP512 FEED STAGE MONITOR FUNCTION</td>
        <td><select><option>ON</option><option>OFF</option></select></td>
        <td><select><option>ON</option><option>OFF</option></select></td>
        <td><select><option>ON</option><option>OFF</option></select></td>
    </tr>
    <tr>
        <td>SP513 START POSITION</td>
        <td><input/></td>
        <td><input/></td>
        <td><input/></td>
    </tr>
    <tr>
        <td>SP514 END POSITION</td>
        <td><input/></td>
        <td><input/></td>
        <td><input/></td>
    </tr>
    <tr>
        <td>SP515 MON UPPER LOAD</td>
        <td><input/></td>
        <td><input/></td>
        <td><input/></td>
    </tr>
    <tr>
        <td>SP516 MON LOWER LOAD</td>
        <td><input/></td>
        <td><input/></td>
        <td><input/></td>
    </tr>
    <tr>
        <td>SP517 FEED STAGE FLS-CHANGE PT</td>
        <td><input/></td>
        <td><input/></td>
        <td><input/></td>
    </tr>
    <tr>
        <td>SP518 FEED STAGE FL SPEED</td>
        <td><input/></td>
        <td><input/></td>
        <td><input/></td>
    </tr>
    <tr>
        <td>SP519 FEED STAGE MAX POSITION</td>
        <td><input/></td>
        <td><input/></td>
        <td><input/></td>
    </tr>
    <tr>
        <td>SP520 FEED STAGE MIN POSITION</td>
        <td><input/></td>
        <td><input/></td>
        <td><input/></td>
    </tr>

    <tr bgcolor="#ffe4c4">
        <td >PRESS STAGE</td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>SP601 PRESSING METHOD</td>
        <td><select id="ch1_pressing_method"><option>LOAD</option><option>POS</option></select></td>
        <td><select id="ch2_pressing_method"><option>LOAD</option><option>POS</option></select></td>
        <td><select id="ch3_pressing_method"><option>LOAD</option><option>POS</option></select></td>
    </tr>
    <tr>
        <td>SP602 PRESS STAGE TARGET LOAD</td>
        <td><input id="ch1_press_stage_target_load"/></td>
        <td><input id="ch2_press_stage_target_load"/></td>
        <td><input id="ch3_press_stage_target_load"/></td>
    </tr>
    <tr>
        <td>SP603 PRESS STAGE UPPER LOAD</td>
        <td><input/></td>
        <td><input/></td>
        <td><input/></td>
    </tr>
    <tr>
        <td>SP604 PRESS STAGE LOWER LOAD</td>
        <td><input/></td>
        <td><input/></td>
        <td><input/></td>
    </tr>
    <tr>
        <td>SP605 SNUG LOAD</td>
        <td><input/></td>
        <td><input/></td>
        <td><input/></td>
    </tr>
    <tr>
        <td>SP606 TARGET POSITION/td>
        <td><input/></td>
        <td><input/></td>
        <td><input/></td>
    </tr>
    <tr>
        <td>SP607 UPPER POSITION/td>
        <td><input/></td>
        <td><input/></td>
        <td><input/></td>
    </tr>
    <tr>
        <td>SP608 LOWER POSITION/td>
        <td><input/></td>
        <td><input/></td>
        <td><input/></td>
    </tr>
    <tr>
        <td>SP609 SNUG POSITION LIMIT/td>
        <td><input/></td>
        <td><input/></td>
        <td><input/></td>
    </tr>
    <tr>
        <td>SP610 PRESS STAGE LOW SPEED/td>
        <td><input/></td>
        <td><input/></td>
        <td><input/></td>
    </tr>


</table>

<script src="/socket.io/socket.io.js"></script>
<script>
    $("#InputTable_Temp").hide();
    var xmlDoc;
    var setupList=[];
    var serverIP="ws://127.0.0.1:5866";

    var SetupElement=function (ch,cmdNum,cmdName,paraName,paraNmae_abra,processName) {

        this.CH=ch;
        this.cmdNum=cmdNum;
        this.cmdName=cmdName;
        this.paraName=paraName;
        this.paraName_abra=paraNmae_abra;
        this.processName=processName;

    }

    function GetSetupList() {
        setupList[setupList.length]=new SetupElement(1,17,"MoveEAP","pos","pos","FEED DOWN");
        setupList[setupList.length]=new SetupElement(1,17,"MoveEAP","acc","acc","FEED DOWN");
        setupList[setupList.length]=new SetupElement(1,17,"MoveEAP","vel","v","FEED DOWN");
        setupList[setupList.length]=new SetupElement(1,18,"MoveEAP","pos","pos","FEED UP");
        setupList[setupList.length]=new SetupElement(1,18,"MoveEAP","vel","v","FEED UP");
    }

    GetSetupList();

    document.getElementById("serverIP").onchange=function(){
        var str=document.getElementById("serverIP").value;
        if (str!=""&&str!=null){
            serverIP="ws://"+str+":5866";
            console.log(serverIP);
        }
    }

    document.getElementById("getXml").onclick=function(){
        $("#InputTable_Temp").show();
        SendCmd("2&1&0&0&0&GetXml --check_none");
    }

    function GetXmlDoc(data){
        console.log(data);
        var parser=new DOMParser();
        xmlDoc=parser.parseFromString(data,"text/xml");
        for (var i=0;i<setupList.length;i++){
            var CH_list=xmlDoc.getElementsByTagName("CmdList");
            var para_value=[];
            var ui_id=[];
            for (var j=0;j<CH_list.length;j++){
                var cmdList=CH_list[j].getElementsByTagName("cmd");
                //获得命令
                var cmd_toSet=cmdList[setupList[i].cmdNum-1].childNodes[0].nodeValue;
                //解析命令得到参数值

                var cmd_paraList=cmd_toSet.split(" ");
                for (var k = 0; k < cmd_paraList.length;k++){
                    if (cmd_paraList[k].indexOf("--"+setupList[i].paraName+"=")>-1 || cmd_paraList[k].indexOf("-"+setupList[i].paraName_abra+"=")>-1){
                        para_value[j]=cmd_paraList[k].split("=")[1];
                    }
                }
                ui_id[j]="ch"+(j+1).toString()+"_"+setupList[i].cmdNum+"_"+setupList[i].cmdName+"_"+setupList[i].paraName;
            }
            //生成UI并赋值
            var processName=setupList[i].processName+"_"+setupList[i].paraName.toUpperCase();
            var tr="<tr><td>"+processName+"</td><td><input value="+para_value[0]+" id='"+ui_id[0]+"'/></td><td><input value="+para_value[1]+" id='"+ui_id[1]+"'/></td><td><input value="+para_value[2]+" id='"+ui_id[2]+"'/></td></tr>"
            //console.log(tr);
            $("#InputTable_Temp").append(tr);
        }
    }

    document.getElementById("saveXml").onclick= function() {

        for (var i=0;i<setupList.length;i++){
            var CH_list=xmlDoc.getElementsByTagName("CmdList");
            var para_value=[];
            var ui_id=[];
            for (var j=0;j<CH_list.length;j++){
                //获得UI值
                ui_id[j]="ch"+(j+1).toString()+"_"+setupList[i].cmdNum+"_"+setupList[i].cmdName+"_"+setupList[i].paraName;
                console.log(ui_id[j]);

                para_value[j]=$("#"+ui_id[j]).val();
                console.log(para_value[j]);


                var cmdList=CH_list[j].getElementsByTagName("cmd");
                //获得命令
                var cmd_toSet=cmdList[setupList[i].cmdNum-1].childNodes[0].nodeValue;
                //解析命令并赋值新参数
                var cmd_toSet_new="";

                var cmd_paraList=cmd_toSet.split(" ");
                for (var k = 0; k < cmd_paraList.length;k++){
                    if (cmd_paraList[k].indexOf("--"+setupList[i].paraName+"=")>-1 || cmd_paraList[k].indexOf("-"+setupList[i].paraName_abra+"=")>-1){
                        //para_value[j]=cmd_paraList[k].split("=")[1];
                        var newParaStr=cmd_paraList[k].split("=")[0]+"="+para_value[j];
                        cmd_paraList[k]=newParaStr;
                    }
                    cmd_toSet_new+=cmd_paraList[k]+" ";
                }
                cmdList[setupList[i].cmdNum-1].childNodes[0].nodeValue=cmd_toSet_new;
                console.log(cmd_toSet_new);
            }
        }

        var text = (new XMLSerializer()).serializeToString(xmlDoc);
        console.log(text);
        SendCmd("3&1&0&0&0&"+text);

        ws.close();
        var url="PressMonitor.html?ServerIp="+escape( serverIP);
        location.href=url;

    }

</script>


<script type="text/javascript">

    var ws;

    function PackBotCmd(str) {
        //1&1&0&0&0&Read --check_none
        var strArray=str.split("&");
        if (strArray.length>3){
            var cmd_id=parseInt(strArray[0]);
            var cmd_option=parseInt((strArray[1]));
            var res_1=parseInt((strArray[2]));
            var res_2=parseInt((strArray[3]));
            var res_3=parseInt((strArray[4]));
            //var byte_cmd=stringToByte(strArray[5]);
            var mes_length=strArray[5].length;
            var buffer=new ArrayBuffer(40+mes_length);
            var headView=new DataView(buffer);
            // var mesView=new Uint16Array(buffer,40,mes_length*2);
            // for (var i = 0, strLen = strArray[5].length; i < strLen; i++) {
            //     mesView[i] = strArray[5].charCodeAt(i);
            // }
            headView.setInt32(0,mes_length,true);
            headView.setInt32(4,cmd_id,true);
            headView.setInt32(8,cmd_option,true);
            headView.setInt32(16,res_1,true);
            headView.setInt32(24,res_2,true);
            headView.setInt32(32,res_3,true);
            for (var i=0;i<mes_length;i++){
                headView.setUint8(40+i,strArray[5].charCodeAt(i));
            }
            // console.log(headView.buffer.byteLength);
            // var getMess=String.fromCharCode.apply(null,new Uint8Array(headView.buffer,40));
            // console.log(getMess);

            ws.send(headView.buffer);
            console.log("send cmd"+headView.buffer.byteLength);

        }
    }

    function AnalizeBotData(buffer) {
        var dataView=new DataView(buffer);
        var cmd_length=dataView.getInt32(0);
        console.log("cmd_length"+cmd_length);
        var cmd_id=dataView.getInt32(4,true);
        console.log("cmd_id"+cmd_id);
        var getMess;
        //getMess=String.fromCharCode.apply(null,new Uint16Array(buffer));
        //console.log(getMess);
        //return string message
        if (cmd_id==2){
            //console.log(buffer.toString());
            getMess=String.fromCharCode.apply(null,new Uint8Array(buffer,40));
            //console.log(getMess.length);
            console.log(getMess);
            GetXmlDoc(getMess);
            //return getMess;
        }
        //return float message
        if (cmd_id=0){
            var step=new Array();
            for(var i=0;i<(dataView.length-40)/8;i++){
                step[i]=dataView.getFloat64(432+i*8);
            }
            //return step;
        }
    }

    function buildWS() {
        ws=new WebSocket(serverIP);
        //  ws=new WebSocket("ws://10.10.10.126:5866");
        // ws=new WebSocket("ws://120.27.231.59:8001");
        ws.onopen=function (evt) {
            console.log("Connection open...");
            // ws.send("Hello");

        }
        ws.onmessage=function (evt) {
            // receiveStr=evt.data;
            // console.log(receiveStr);
            if (typeof evt.data=== String){
                console.log("Received "+evt.data);
                receiveStr=evt.data;
            }
            if (evt.data instanceof ArrayBuffer){
                console.log("receive byte"+evt.data.byteLength);
                AnalizeBotData(evt.data);
            }


        }
        ws.onclose=function (evt) {
            console.log("closed");

        }
    }

    buildWS();

    function SendCmd(cmd){
        switch (ws.readyState) {
            case WebSocket.CONNECTING:
                break;
            case WebSocket.OPEN:
                ws.binaryType='arraybuffer';
                PackBotCmd(cmd);
                //ws.send(PackBotCmd("1&1&0&0&0&Read --check_none"));
                //ws.send("hello");
                //CheckData(receiveStr);
                break;
            case  WebSocket.CLOSING:
                break;
            case WebSocket.CLOSED:
                buildWS();
                break;
        }
    }

</script>


<script type="text/javascript">
    $("#getXml").button();
    $("#saveXml").button();
    $("#run").button();
    $( "#accordion" ).accordion({
        heightStyle:"content",
        collapsible: "true"

    });

</script>
</body>
</html>
